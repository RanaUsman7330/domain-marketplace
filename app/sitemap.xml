import { getConnection } from '../../../lib/mysql-db';
import { NextResponse } from 'next/server';

export async function GET() {
  try {
    const connection = getConnection();
    const [domains] = await connection.execute('SELECT name FROM domains');
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

    const urls = [
      { url: `${baseUrl}/`, lastmod: new Date().toISOString() },
      { url: `${baseUrl}/domains`, lastmod: new Date().toISOString() },
      ...domains.map((d: any) => ({ url: `${baseUrl}/domains/${d.name}`, lastmod: new Date().toISOString() })),
    ];

    const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urls.map(u => `<url><loc>${u.url}</loc><lastmod>${u.lastmod}</lastmod></url>`).join('\n')}
</urlset>`;

    return new NextResponse(sitemap, { headers: { 'Content-Type': 'application/xml' } });
  } catch (error) {
    return NextResponse.json({ error: 'Failed to generate sitemap' }, { status: 500 });
  }
}